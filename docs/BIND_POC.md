# NDash - Bind Integration PoC Guide

## üéØ Proof of Concept Overview

NDash sekarang terintegrasi langsung dengan Bind DNS server. Dashboard dapat:
- ‚úÖ Membaca zones dari `named.conf.local`
- ‚úÖ Parsing zone files di `/etc/bind/zones/`
- ‚úÖ Membuat zone baru dengan auto-generate zone file
- ‚úÖ Menambah DNS records ke zone file
- ‚úÖ Menghapus records dari zone file
- ‚úÖ Auto-increment serial number
- ‚úÖ Reload Bind service setelah perubahan
- ‚úÖ Validasi zone syntax dengan `named-checkzone`

## üìã Prerequisites

### 1. Install Bind9
```bash
sudo apt update
sudo apt install bind9 bind9utils bind9-doc
```

### 2. Setup Bind Directories
```bash
# Create zones directory
sudo mkdir -p /etc/bind/zones
sudo chown bind:bind /etc/bind/zones
sudo chmod 755 /etc/bind/zones

# Backup original config
sudo cp /etc/bind/named.conf.local /etc/bind/named.conf.local.backup
```

### 3. Setup Permissions untuk NDash
NDash perlu akses untuk menulis zone files dan reload Bind.

**Option A: Run NDash sebagai root** (Development only)
```bash
sudo npm start
```

**Option B: Setup sudo permissions** (Recommended)
```bash
# Buat user ndash
sudo useradd -r -s /bin/false ndash

# Add sudoers rule
sudo visudo
# Tambahkan:
ndash ALL=(ALL) NOPASSWD: /usr/sbin/rndc reload
ndash ALL=(ALL) NOPASSWD: /usr/sbin/named-checkzone

# Set ownership
sudo chown -R ndash:bind /etc/bind/zones
sudo chmod 775 /etc/bind/zones
```

### 4. Configure Bind
Edit `/etc/bind/named.conf.options`:
```bind
options {
    directory "/var/cache/bind";
    
    // Allow queries from your network
    allow-query { localhost; 192.168.0.0/16; };
    
    // Disable recursion for authoritative server
    recursion no;
    
    // Listen on all interfaces
    listen-on { any; };
    listen-on-v6 { any; };
};
```

## üöÄ Testing the PoC

### Step 1: Start NDash
```bash
cd /opt/ndash
sudo npm start
```

Atau dengan PM2:
```bash
sudo pm2 start server.js --name ndash
```

### Step 2: Access Dashboard
```
http://localhost:3000
```

### Step 3: Create Test Zone

#### Via UI:
1. Click **"Create Zone"**
2. Zone Name: `test.local`
3. Click **"Create Zone"**

#### Via CLI (untuk testing):
```bash
# NDash akan create file ini otomatis via UI
sudo nano /etc/bind/zones/db.test.local
```

### Step 4: Verify Zone Created
```bash
# Check zone file
cat /etc/bind/zones/db.test.local

# Check named.conf.local
cat /etc/bind/named.conf.local | grep test.local

# Check Bind status
sudo rndc status

# Query zone
dig @localhost test.local SOA
```

### Step 5: Add DNS Records

#### Via UI:
1. Open zone detail: `http://localhost:3000/zones/test.local`
2. Click **"Add Record"**
3. Add records:
   - Name: `@`, Type: `A`, Value: `192.168.1.100`
   - Name: `www`, Type: `A`, Value: `192.168.1.100`
   - Name: `mail`, Type: `A`, Value: `192.168.1.101`
   - Name: `@`, Type: `MX`, Value: `mail.test.local`, Priority: `10`

### Step 6: Test DNS Resolution
```bash
# Test A record
dig @localhost test.local A

# Test www subdomain
dig @localhost www.test.local A

# Test MX record
dig @localhost test.local MX

# Test all records
dig @localhost test.local ANY
```

## üîß Troubleshooting

### Problem: Permission Denied
```bash
# Check directory permissions
ls -la /etc/bind/zones/

# Fix permissions
sudo chown -R bind:bind /etc/bind/zones
sudo chmod 755 /etc/bind/zones
sudo chmod 644 /etc/bind/zones/*
```

### Problem: Bind Reload Failed
```bash
# Check Bind config syntax
sudo named-checkconf

# Check zone syntax
sudo named-checkzone test.local /etc/bind/zones/db.test.local

# Check Bind logs
sudo tail -f /var/log/syslog | grep named

# Restart Bind
sudo systemctl restart bind9
```

### Problem: Zone Not Resolving
```bash
# Check Bind is running
sudo systemctl status bind9

# Check if zone is loaded
sudo rndc status

# Force reload
sudo rndc reload

# Check zone status
sudo rndc zonestatus test.local
```

### Problem: NDash Can't Read Zones
```bash
# Check file exists
ls -l /etc/bind/named.conf.local
ls -l /etc/bind/zones/

# Check NDash logs
tail -f /var/log/syslog | grep ndash

# Or if using PM2
pm2 logs ndash
```

## üìä What Gets Created

### When Creating Zone `example.com`:

**1. Zone File:** `/etc/bind/zones/db.example.com`
```bind
; Zone file for example.com
; Generated by NDash
;
$TTL 3600
@       IN      SOA     ns1.example.com. admin.example.com. (
                        2024111401      ; Serial
                        7200            ; Refresh
                        3600            ; Retry
                        1209600         ; Expire
                        3600 )          ; Minimum TTL
;
; Name servers
@       IN      NS      ns1.example.com.
;
; A records
@       IN      A       127.0.0.1
```

**2. Config Entry:** Added to `/etc/bind/named.conf.local`
```bind
zone "example.com" {
    type master;
    file "/etc/bind/zones/db.example.com";
    allow-transfer { none; };
};
```

**3. Bind Reloaded:**
```bash
rndc reload
```

## üß™ Testing Checklist

- [ ] Create new zone via UI
- [ ] Zone file created in `/etc/bind/zones/`
- [ ] Zone added to `named.conf.local`
- [ ] Bind reloaded successfully
- [ ] Zone resolves via `dig`
- [ ] Add A record
- [ ] Add CNAME record
- [ ] Add MX record
- [ ] Records resolve correctly
- [ ] Delete record
- [ ] Record removed from zone file
- [ ] Serial number incremented
- [ ] Delete zone
- [ ] Zone file backed up
- [ ] Zone removed from config

## üìù Important Notes

### Serial Number
- Auto-increments on every change
- Format: `YYYYMMDDNN` (e.g., 2024111401)
- Critical untuk DNS replication

### Zone File Syntax
- Bind is very strict about syntax
- Trailing dots (.) are important
- Whitespace matters
- Comments start with `;`

### Security Considerations
‚ö†Ô∏è **Production Requirements:**
- Run NDash as dedicated user (not root)
- Use sudo for rndc commands only
- Restrict file permissions
- Enable audit logging
- Implement authentication
- Use firewall rules

## üéØ Next Steps

### Immediate Testing
```bash
# 1. Create zone
curl -X POST http://localhost:3000/zones \
  -d "name=poc-test.local"

# 2. Verify in Bind
dig @localhost poc-test.local SOA

# 3. Add record via UI
# Open: http://localhost:3000/zones/poc-test.local

# 4. Test resolution
dig @localhost poc-test.local A
```

### Production Deployment
1. Setup proper user permissions
2. Configure systemd service
3. Setup Nginx reverse proxy
4. Enable HTTPS
5. Implement authentication
6. Setup monitoring
7. Configure backup system

## üìö Reference Commands

```bash
# Bind Management
sudo systemctl status bind9
sudo systemctl restart bind9
sudo rndc reload
sudo rndc status
sudo rndc zonestatus <zone>

# Zone Validation
sudo named-checkconf
sudo named-checkzone <zone> <file>

# DNS Testing
dig @localhost <zone> SOA
dig @localhost <zone> NS
dig @localhost <zone> A
dig @localhost <zone> ANY
nslookup <zone> localhost

# File Locations
/etc/bind/named.conf.local      # Zone configurations
/etc/bind/zones/                # Zone files
/var/log/syslog                 # Bind logs
```

## ‚úÖ Success Criteria

PoC berhasil jika:
- ‚úÖ Dashboard dapat list existing zones
- ‚úÖ Dapat create zone baru via UI
- ‚úÖ Zone file auto-generated dengan format benar
- ‚úÖ Bind reload tanpa error
- ‚úÖ Zone resolve via DNS query
- ‚úÖ Dapat add/delete records via UI
- ‚úÖ Records langsung aktif setelah ditambahkan
- ‚úÖ Serial number auto-increment
- ‚úÖ Zone syntax validation berfungsi

---

**Status**: Ready for Testing
**Last Updated**: November 14, 2024

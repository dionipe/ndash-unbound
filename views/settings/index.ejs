<%- include('../partials/header-standalone') %>

<div class="mb-6">
    <h3 class="text-2xl font-bold text-gray-800">System Settings</h3>
    <p class="text-gray-600 mt-1">Configure NDash and Unbound DNS server settings</p>
</div>

<% if (typeof success !== 'undefined' && success) { %>
    <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-check-circle mr-2"></i>
        <%= decodeURIComponent(success) %>
    </div>
<% } %>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <%= decodeURIComponent(error) %>
    </div>
<% } %>

<!-- Quick Status Overview -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-server text-blue-600 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-sm font-medium text-gray-900">Unbound Status</h4>
                <p class="text-sm text-gray-500" id="status-indicator">Loading...</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-network-wired text-green-600 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-sm font-medium text-gray-900">Resolver</h4>
                <p class="text-sm text-gray-500" id="resolver-indicator">
                    <%= settings.resolver && settings.resolver.enabled ? 'Enabled' : 'Disabled' %>
                </p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-shield-alt text-yellow-600 text-2xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-sm font-medium text-gray-900">DoT/DoH</h4>
                <p class="text-sm text-gray-500" id="tls-indicator">
                    <%= (settings.unbound && settings.unbound.dotEnabled) || (settings.unbound && settings.unbound.dohEnabled) ? 'Enabled' : 'Disabled' %>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-4 lg:gap-6">
    <!-- Unbound Configuration -->
    <div class="xl:col-span-2 space-y-4 lg:space-y-6">
        <!-- Server Information -->
        <div class="content-card">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-server mr-2 text-blue-600"></i>
                    Server Information
                </h4>
                <button onclick="refreshStatus()" class="btn-sm btn-primary">
                    <i class="fas fa-sync-alt mr-1" id="refresh-icon"></i>
                    Refresh
                </button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="server-info">
                <div class="border-l-4 border-blue-500 pl-4">
                    <p class="text-sm text-gray-600">Unbound Version</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.unbound ? settings.unbound.version : 'N/A' %></p>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <p class="text-sm text-gray-600">Node.js Version</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.server.nodeVersion %></p>
                </div>
                <div class="border-l-4 border-purple-500 pl-4">
                    <p class="text-sm text-gray-600">Platform</p>
                    <p class="text-lg font-semibold text-gray-800"><%= settings.server.platform %></p>
                </div>
                <div class="border-l-4 border-orange-500 pl-4">
                    <p class="text-sm text-gray-600">Uptime</p>
                    <p class="text-lg font-semibold text-gray-800"><%= Math.floor(settings.server.uptime / 60) %> minutes</p>
                </div>
            </div>
        </div>

        <!-- Unbound Paths -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-folder mr-2 text-yellow-600"></i>
                Unbound Configuration Paths
            </h4>
            
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Main Config File</p>
                        <p class="text-sm text-gray-600 font-mono">/etc/unbound/unbound.conf</p>
                    </div>
                    <i class="fas fa-file-code text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Local Zones Directory</p>
                        <p class="text-sm text-gray-600 font-mono">/etc/unbound/local.d</p>
                    </div>
                    <i class="fas fa-folder-open text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Control Socket</p>
                        <p class="text-sm text-gray-600 font-mono">/var/run/unbound.ctl</p>
                    </div>
                    <i class="fas fa-plug text-gray-400"></i>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Log File</p>
                        <p class="text-sm text-gray-600 font-mono">/var/log/unbound.log</p>
                    </div>
                    <i class="fas fa-file-alt text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Zone Management Settings -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-cogs mr-2 text-indigo-600"></i>
                Zone Management Settings
            </h4>
            <p class="text-sm text-gray-600 mb-4">Configure how NDash handles DNS zone operations</p>
            
            <form method="POST" action="/settings" class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Auto Reload Unbound</p>
                        <p class="text-xs text-gray-600">Automatically reload Unbound after zone changes</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="autoReload" class="sr-only peer" <%= settings.zones.autoReload ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Validate Before Reload</p>
                        <p class="text-xs text-gray-600">Check zone syntax before reloading Unbound</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="validateBeforeReload" class="sr-only peer" <%= settings.zones.validateBeforeReload ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Backup Enabled</p>
                        <p class="text-xs text-gray-600">Create backups before modifying zones</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="backupEnabled" class="sr-only peer" <%= settings.zones.backupEnabled ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div>
                        <p class="text-sm font-medium text-gray-700">Auto Generate PTR Records</p>
                        <p class="text-xs text-gray-600">Auto-create 254 PTR records for reverse zones</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="autoGeneratePTR" class="sr-only peer" <%= settings.zones.autoGeneratePTR ? 'checked' : '' %>>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="btn btn-primary w-full" id="save-settings-btn">
                        <i class="fas fa-save mr-2"></i>
                        Save Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- DNS Resolver Settings -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-network-wired mr-2 text-green-600"></i>
                DNS Resolver Settings
            </h4>
            <p class="text-sm text-gray-600 mb-4">Configure Unbound DNS resolver behavior and performance</p>
            
            <form method="POST" action="/settings/resolver">
                <!-- Enable Resolver -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Enable DNS Resolver</label>
                            <p class="text-xs text-gray-500">Allow Unbound to resolve internet domains</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="resolverEnabled" class="sr-only peer" <%= settings.resolver && settings.resolver.enabled ? 'checked' : '' %>>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>

                <div id="resolver-options" class="<%= settings.resolver && settings.resolver.enabled ? '' : 'hidden' %>">
                    <!-- Forwarding -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Enable Forwarding</label>
                                <p class="text-xs text-gray-500">Forward queries to upstream DNS servers</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="forwardingEnabled" class="sr-only peer" <%= settings.resolver && settings.resolver.forwardingEnabled ? 'checked' : '' %>>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Upstream DNS Servers -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Upstream DNS Servers
                        </label>
                        <div class="space-y-2">
                            <% if (settings.resolver && settings.resolver.upstreamDNS) { %>
                                <% settings.resolver.upstreamDNS.forEach((dns, index) => { %>
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" name="upstream_<%= index %>_enabled" <%= dns.enabled ? 'checked' : '' %> class="w-4 h-4 text-blue-600">
                                            <span class="text-sm font-medium"><%= dns.name %></span>
                                            <span class="text-xs text-gray-500"><%= dns.address %>:<%= dns.port %></span>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                    </div>

                    <!-- Cache Settings -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cache Size</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-600">Message Cache (MB)</label>
                                <input type="number" name="cacheSizeMsg" value="<%= settings.resolver ? settings.resolver.cacheSize.msg : 16 %>" class="form-input text-sm" min="4" max="256">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">RRset Cache (MB)</label>
                                <input type="number" name="cacheSizeRrset" value="<%= settings.resolver ? settings.resolver.cacheSize.rrset : 32 %>" class="form-input text-sm" min="4" max="512">
                            </div>
                        </div>
                    </div>

                    <!-- Cache TTL -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cache TTL (seconds)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-600">Minimum</label>
                                <input type="number" name="cacheTTLMin" value="<%= settings.resolver ? settings.resolver.cacheTTL.min : 300 %>" class="form-input text-sm" min="0" max="3600">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Maximum</label>
                                <input type="number" name="cacheTTLMax" value="<%= settings.resolver ? settings.resolver.cacheTTL.max : 86400 %>" class="form-input text-sm" min="3600" max="604800">
                            </div>
                        </div>
                    </div>

                    <!-- Performance -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Performance</label>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Number of Threads</span>
                                <input type="number" name="numThreads" value="<%= settings.resolver ? settings.resolver.performance.numThreads : 2 %>" class="form-input text-sm w-20" min="1" max="8">
                            </div>
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Prefetch Popular Entries</span>
                                <input type="checkbox" name="prefetch" <%= settings.resolver && settings.resolver.performance.prefetch ? 'checked' : '' %>>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Prefetch DNSSEC Keys</span>
                                <input type="checkbox" name="prefetchKey" <%= settings.resolver && settings.resolver.performance.prefetchKey ? 'checked' : '' %>>
                            </div>
                        </div>
                    </div>

                    <!-- Security -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Security & Privacy</label>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Hide Server Identity</span>
                                <input type="checkbox" name="hideIdentity" <%= settings.resolver && settings.resolver.security.hideIdentity ? 'checked' : '' %>>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Hide Server Version</span>
                                <input type="checkbox" name="hideVersion" <%= settings.resolver && settings.resolver.security.hideVersion ? 'checked' : '' %>>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Enable DNSSEC</span>
                                <input type="checkbox" name="dnssec" <%= settings.resolver && settings.resolver.security.dnssec ? 'checked' : '' %>>
                            </div>
                        </div>
                    </div>

                    <!-- Encrypted DNS Protocols -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Encrypted DNS Protocols</label>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded" id="dot-setting">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-lock text-blue-600"></i>
                                    <div>
                                        <span class="text-sm font-medium">DNS over TLS (DoT)</span>
                                        <span class="text-xs text-gray-500 block">Port <%= settings.unbound && settings.unbound.dotPort ? settings.unbound.dotPort : 853 %></span>
                                    </div>
                                </div>
                                <input type="checkbox" name="dotEnabled" <%= settings.unbound && settings.unbound.dotEnabled ? 'checked' : '' %>>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded" id="doh-setting">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-shield-alt text-green-600"></i>
                                    <div>
                                        <span class="text-sm font-medium">DNS over HTTPS (DoH)</span>
                                        <span class="text-xs text-gray-500 block">Port <%= settings.unbound && settings.unbound.dohPort ? settings.unbound.dohPort : 443 %> • Endpoint: <%= settings.unbound && settings.unbound.dohEndpoint ? settings.unbound.dohEndpoint : '/dns-query' %></span>
                                    </div>
                                </div>
                                <input type="checkbox" name="dohEnabled" <%= settings.unbound && settings.unbound.dohEnabled ? 'checked' : '' %>>
                            </div>
                        </div>
                        <div id="tls-notice" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5 mr-2"></i>
                                <div class="flex-1">
                                    <h5 class="text-sm font-medium text-yellow-800">TLS Server Not Supported</h5>
                                    <p class="text-xs text-yellow-700 mt-1">
                                        Unbound must be compiled with <code class="bg-yellow-200 px-1 rounded">--enable-tls-server</code> flag to support DoT/DoH.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Encrypted DNS protocols provide privacy and security for DNS queries
                        </p>
                    </div>

                    <!-- Access Control -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Allowed Networks
                        </label>
                        <div class="space-y-2">
                            <% if (settings.resolver && settings.resolver.access && settings.resolver.access.allowedNetworks) { %>
                                <% settings.resolver.access.allowedNetworks.forEach((net, index) => { %>
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" name="network_<%= index %>_enabled" <%= net.enabled ? 'checked' : '' %> class="w-4 h-4 text-blue-600">
                                            <div>
                                                <span class="text-sm font-medium"><%= net.network %></span>
                                                <span class="text-xs text-gray-500 block"><%= net.description %></span>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                    </div>

                    <!-- Logging -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Logging</label>
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div>
                                <label class="text-xs text-gray-600">Verbosity (0-5)</label>
                                <input type="number" name="verbosity" value="<%= settings.resolver ? settings.resolver.logging.verbosity : 1 %>" class="form-input text-sm" min="0" max="5">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Log Queries</span>
                                <input type="checkbox" name="logQueries" <%= settings.resolver && settings.resolver.logging.logQueries ? 'checked' : '' %>>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-sm">Log Replies</span>
                                <input type="checkbox" name="logReplies" <%= settings.resolver && settings.resolver.logging.logReplies ? 'checked' : '' %>>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pt-4 space-y-2">
                    <button type="submit" id="apply-resolver-btn" class="btn btn-primary w-full">
                        <i class="fas fa-save mr-2"></i>
                        Apply Resolver Settings
                    </button>
                    <button type="button" onclick="testResolver()" class="btn btn-secondary w-full">
                        <i class="fas fa-vial mr-2"></i>
                        Test DNS Resolution
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SSL Certificate Management -->
    <div class="xl:col-span-1 space-y-4 lg:space-y-6">
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-certificate mr-2 text-green-600"></i>
                SSL Certificates (DoT/DoH)
            </h4>
            <p class="text-sm text-gray-600 mb-4">Manage SSL certificates for encrypted DNS protocols</p>

            <div id="ssl-cert-info" class="space-y-3">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i>
                    <p class="text-sm text-gray-600">Loading certificate info...</p>
                </div>
            </div>

            <div class="mt-4 space-y-2">
                <button onclick="loadSSLCertInfo()" class="btn-sm btn-primary w-full">
                    <i class="fas fa-sync-alt mr-1"></i>
                    Refresh Info
                </button>
                <button onclick="regenerateSSLCert()" class="btn-sm btn-secondary w-full">
                    <i class="fas fa-redo mr-1"></i>
                    Regenerate Certificates
                </button>
            </div>
        </div>

        <!-- Status Overview Grid -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Resolver Status -->
            <div class="content-card">
                <h4 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-globe mr-2 text-green-600 text-sm"></i>
                    Resolver
                </h4>
                
                <div id="resolver-status" class="space-y-2">
                    <div class="text-center py-2">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600 mx-auto"></div>
                        <p class="text-xs text-gray-600 mt-1">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Unbound Status -->
            <div class="content-card">
                <h4 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-heartbeat mr-2 text-red-600 text-sm"></i>
                    Unbound
                </h4>
                
                <div id="unbound-status" class="space-y-2">
                    <div class="text-center py-2">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="text-xs text-gray-600 mt-1">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-bolt mr-2 text-yellow-600"></i>
                Quick Actions
            </h4>
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="reloadUnbound()" class="btn-sm btn-primary">
                    <i class="fas fa-sync-alt mr-1"></i>
                    Reload
                </button>
                
                <button onclick="checkConfig()" class="btn-sm">
                    <i class="fas fa-check-circle mr-1"></i>
                    Check
                </button>
                
                <button onclick="viewLogs()" class="btn-sm">
                    <i class="fas fa-file-alt mr-1"></i>
                    Logs
                </button>
                
                <a href="/zones" class="btn-sm block text-center">
                    <i class="fas fa-globe mr-1"></i>
                    Zones
                </a>
            </div>
        </div>

        <!-- System Info -->
        <div class="content-card">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                About NDash
            </h4>
            
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Version</span>
                    <span class="font-semibold">1.0.0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Server Port</span>
                    <span class="font-semibold"><%= settings.server.port %></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Repository</span>
                    <a href="https://github.com/dionipe/ndash" target="_blank" class="text-blue-600 hover:underline text-sm">
                        <i class="fab fa-github mr-1"></i>GitHub
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Form validation
function validateResolverForm() {
    const numThreads = document.querySelector('input[name="numThreads"]');
    const cacheMsg = document.querySelector('input[name="cacheSizeMsg"]');
    const cacheRrset = document.querySelector('input[name="cacheSizeRrset"]');
    const cacheMin = document.querySelector('input[name="cacheTTLMin"]');
    const cacheMax = document.querySelector('input[name="cacheTTLMax"]');
    const verbosity = document.querySelector('input[name="verbosity"]');
    
    // Validate number inputs
    if (numThreads && (numThreads.value < 1 || numThreads.value > 8)) {
        showNotification('Number of threads must be between 1 and 8', 'error');
        return false;
    }
    
    if (cacheMsg && (cacheMsg.value < 4 || cacheMsg.value > 256)) {
        showNotification('Message cache size must be between 4 and 256 MB', 'error');
        return false;
    }
    
    if (cacheRrset && (cacheRrset.value < 4 || cacheRrset.value > 512)) {
        showNotification('RRset cache size must be between 4 and 512 MB', 'error');
        return false;
    }
    
    if (cacheMin && cacheMax && parseInt(cacheMin.value) >= parseInt(cacheMax.value)) {
        showNotification('Minimum cache TTL must be less than maximum', 'error');
        return false;
    }
    
    if (verbosity && (verbosity.value < 0 || verbosity.value > 5)) {
        showNotification('Verbosity must be between 0 and 5', 'error');
        return false;
    }
    
    return true;
}

// Update form submit handlers with validation
document.addEventListener('DOMContentLoaded', function() {
    loadUnboundStatus();
    loadResolverStatus();
    checkTLSServerSupport();
    
    // Toggle resolver options visibility
    const resolverEnabledCheckbox = document.querySelector('input[name="resolverEnabled"]');
    if (resolverEnabledCheckbox) {
        resolverEnabledCheckbox.addEventListener('change', function() {
            const options = document.getElementById('resolver-options');
            if (options) {
                if (this.checked) {
                    options.classList.remove('hidden');
                } else {
                    options.classList.add('hidden');
                }
            }
            updateResolverIndicator(this.checked);
        });
    }
    
    // Add form submit handler with validation
    const resolverForm = document.querySelector('form[action="/settings/resolver"]');
    if (resolverForm) {
        resolverForm.addEventListener('submit', function(e) {
            if (!validateResolverForm()) {
                e.preventDefault();
                return false;
            }
        });
    }
    
    // Add form submit handler to show loading state
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            form.addEventListener('submit', function(e) {
                submitBtn.disabled = true;
                const originalHTML = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                
                // Re-enable button after 10 seconds as fallback
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }, 10000);
            });
        }
    });
    
    // Show current settings state in console
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    console.log('Current Settings State:');
    checkboxes.forEach(cb => {
        console.log(`  ${cb.name}: ${cb.checked ? 'ON' : 'OFF'}`);
    });
});

function loadResolverStatus() {
    fetch('/settings/resolver/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('resolver-status');
            if (data.success && data.status) {
                const status = data.status;
                const stats = data.stats || {};
                const statusColor = status.running ? 'green' : 'gray';
                const statusIcon = status.running ? 'check-circle' : 'times-circle';
                
                let html = `
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-${statusColor}-100 mb-1">
                            <i class="fas fa-${statusIcon} text-lg text-${statusColor}-600"></i>
                        </div>
                        <p class="text-xs font-semibold text-gray-800">
                            ${status.enabled ? (status.running ? 'Active' : 'Configured') : 'Disabled'}
                        </p>
                    </div>
                `;
                
                if (status.running && stats.queries !== undefined) {
                    const hitRate = stats.cacheHitRate || 0;
                    html += `
                        <div class="mt-2 pt-2 border-t border-gray-100">
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Queries</span>
                                    <span class="font-semibold text-gray-700">${stats.queries}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Hit Rate</span>
                                    <span class="font-semibold text-blue-600">${hitRate}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                statusDiv.innerHTML = html;
            } else {
                statusDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-lg text-yellow-600 mb-1"></i>
                        <p class="text-xs text-gray-600">Failed</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading resolver status:', error);
        });
}

function testResolver() {
    const domain = prompt('Enter domain to test (e.g., google.com):', 'google.com');
    if (!domain) return;
    
    showNotification('Testing DNS resolution...', 'info');
    
    fetch('/settings/resolver/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain: domain })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`✓ ${domain} → ${data.result}`, 'success');
        } else {
            showNotification(`✗ ${data.message}`, 'error');
        }
    })
    .catch(error => {
        showNotification('Test failed: ' + error.message, 'error');
    });
}

function loadUnboundStatus() {
    fetch('/settings/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('unbound-status');
            const statusIndicator = document.getElementById('status-indicator');
            
            if (data.success) {
                const statusColor = data.status === 'running' ? 'green' : 'red';
                const statusIcon = data.status === 'running' ? 'check-circle' : 'times-circle';
                
                statusDiv.innerHTML = `
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-${statusColor}-100 mb-1">
                            <i class="fas fa-${statusIcon} text-lg text-${statusColor}-600"></i>
                        </div>
                        <p class="text-xs font-semibold text-gray-800 capitalize">${data.status}</p>
                        <p class="text-xs text-gray-500 mt-1">${data.version}</p>
                    </div>
                `;
                
                // Update status indicator
                if (statusIndicator) {
                    statusIndicator.textContent = data.status === 'running' ? 'Running' : 'Stopped';
                    statusIndicator.className = `text-sm ${data.status === 'running' ? 'text-green-600' : 'text-red-600'}`;
                }
            } else {
                statusDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-lg text-yellow-600 mb-1"></i>
                        <p class="text-xs text-gray-600">Failed</p>
                    </div>
                `;
                
                if (statusIndicator) {
                    statusIndicator.textContent = 'Unknown';
                    statusIndicator.className = 'text-sm text-gray-600';
                }
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
        });
}

function refreshStatus() {
    const icon = document.getElementById('refresh-icon');
    icon.classList.add('fa-spin');
    loadUnboundStatus();
    loadResolverStatus();
    setTimeout(() => icon.classList.remove('fa-spin'), 1000);
}

function reloadUnbound() {
    fetch('/zones/reload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(loadUnboundStatus, 500);
        }
    })
    .catch(error => showNotification('Failed to reload Unbound', 'error'));
}

function checkConfig() {
    showNotification('Config check feature coming soon', 'info');
}

function updateResolverIndicator(enabled) {
    const indicator = document.getElementById('resolver-indicator');
    if (indicator) {
        indicator.textContent = enabled ? 'Enabled' : 'Disabled';
        indicator.className = `text-sm ${enabled ? 'text-green-600' : 'text-red-600'}`;
    }
}

function updateTLSIndicator(enabled) {
    const indicator = document.getElementById('tls-indicator');
    if (indicator) {
        indicator.textContent = enabled ? 'Enabled' : 'Disabled';
        indicator.className = `text-sm ${enabled ? 'text-green-600' : 'text-red-600'}`;
    }
}

// Check TLS server support and update UI
function checkTLSServerSupport() {
    fetch('/settings/ssl-cert-info')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                const cert = data.data;
                
                if (cert.tlsServerSupported === false) {
                    // Disable DoT/DoH checkboxes
                    const dotCheckbox = document.querySelector('input[name="dotEnabled"]');
                    const dohCheckbox = document.querySelector('input[name="dohEnabled"]');
                    
                    if (dotCheckbox) {
                        dotCheckbox.disabled = true;
                        dotCheckbox.checked = false;
                    }
                    if (dohCheckbox) {
                        dohCheckbox.disabled = true;
                        dohCheckbox.checked = false;
                    }
                    
                    // Show notice
                    const noticeDiv = document.getElementById('tls-notice');
                    if (noticeDiv) {
                        noticeDiv.classList.remove('hidden');
                    }
                    
                    // Add disabled styling
                    const dotSetting = document.getElementById('dot-setting');
                    const dohSetting = document.getElementById('doh-setting');
                    
                    if (dotSetting) dotSetting.classList.add('opacity-50');
                    if (dohSetting) dohSetting.classList.add('opacity-50');
                    
                    // Update TLS indicator
                    updateTLSIndicator(false);
                } else {
                    updateTLSIndicator(true);
                }
            }
        })
        .catch(error => {
            console.warn('Failed to check TLS server support:', error);
        });
}

// SSL Certificate Management
function loadSSLCertInfo() {
    const certInfoDiv = document.getElementById('ssl-cert-info');

    certInfoDiv.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i>
            <p class="text-sm text-gray-600">Loading certificate info...</p>
        </div>
    `;

    fetch('/settings/ssl-cert-info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const cert = data.data;
                
                // Check TLS server support first
                if (cert.tlsServerSupported === false) {
                    certInfoDiv.innerHTML = `
                        <div class="space-y-3">
                            <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                                <div class="flex items-start">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5 mr-2"></i>
                                    <div class="flex-1">
                                        <h5 class="text-sm font-medium text-yellow-800">TLS Server Not Supported</h5>
                                        <p class="text-xs text-yellow-700 mt-1">
                                            Unbound was not compiled with TLS server support. DoT and DoH have been automatically disabled.
                                        </p>
                                        <div class="mt-2 p-2 bg-yellow-100 rounded text-xs">
                                            <strong>To enable DoT/DoH:</strong><br>
                                            Recompile Unbound with <code class="bg-yellow-200 px-1 rounded">--enable-tls-server</code> flag
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                let statusColor = 'gray';
                let statusIcon = 'fa-question-circle';
                let statusText = 'Unknown';

                if (!cert.exists) {
                    statusColor = 'red';
                    statusIcon = 'fa-times-circle';
                    statusText = 'Not Found';
                } else if (cert.isExpired) {
                    statusColor = 'red';
                    statusIcon = 'fa-exclamation-triangle';
                    statusText = 'Expired';
                } else if (cert.daysUntilExpiry < 30) {
                    statusColor = 'yellow';
                    statusIcon = 'fa-exclamation-triangle';
                    statusText = 'Expires Soon';
                } else {
                    statusColor = 'green';
                    statusIcon = 'fa-check-circle';
                    statusText = 'Valid';
                }

                certInfoDiv.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-2 bg-${statusColor}-50 rounded">
                            <span class="text-sm font-medium text-gray-700">Status</span>
                            <span class="flex items-center text-sm">
                                <i class="fas ${statusIcon} text-${statusColor}-600 mr-1"></i>
                                ${statusText}
                            </span>
                        </div>

                        ${cert.exists ? `
                            <div class="text-xs space-y-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Key File:</span>
                                    <code class="bg-gray-100 px-1 rounded text-xs">${cert.keyFile}</code>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Cert File:</span>
                                    <code class="bg-gray-100 px-1 rounded text-xs">${cert.certFile}</code>
                                </div>
                                ${cert.expiryDate ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Expires:</span>
                                        <span class="text-${cert.daysUntilExpiry < 30 ? 'red' : 'gray'}-600">${cert.expiryDate.toLocaleDateString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Days Left:</span>
                                        <span class="text-${cert.daysUntilExpiry < 30 ? 'red' : 'gray'}-600">${cert.daysUntilExpiry}</span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="text-center py-2">
                                <p class="text-sm text-gray-600">Certificates will be auto-generated when DoT/DoH is enabled</p>
                            </div>
                        `}
                    </div>
                `;
            } else {
                certInfoDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl mb-2"></i>
                        <p class="text-sm text-red-600">Failed to load certificate info</p>
                        <p class="text-xs text-gray-600 mt-1">${data.error || 'Unknown error'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            certInfoDiv.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl mb-2"></i>
                    <p class="text-sm text-red-600">Failed to load certificate info</p>
                    <p class="text-xs text-gray-600 mt-1">Network error</p>
                </div>
            `;
        });
}

function regenerateSSLCert() {
    if (!confirm('Are you sure you want to regenerate SSL certificates? This will create new certificates and may require clients to accept the new certificates.')) {
        return;
    }

    showNotification('Regenerating SSL certificates...', 'info');

    fetch('/settings/regenerate-ssl', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(loadSSLCertInfo, 1000); // Reload info after 1 second
        } else {
            showNotification('Failed to regenerate certificates: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showNotification('Failed to regenerate certificates', 'error');
    });
}

// Load SSL cert info on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSSLCertInfo();
    checkTLSServerSupport();
});

function showNotification(message, type) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    notification.innerHTML = `<i class="fas ${icons[type]} mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}
</script>

<%- include('../partials/footer-standalone') %>
